<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alicon Cortes - Sistema de Agendamento</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #6C63FF;
      --secondary: #4D44DB;
      --success: #28A745;
      --danger: #DC3545;
      --warning: #FFC107;
      --light: #F8F9FA;
      --dark: #343A40;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background-color: #f5f7fa;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* Header */
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    
    /* Card */
    .card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      padding: 25px;
      margin-bottom: 30px;
    }
    
    /* Formulário */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }
    
    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s;
    }
    
    .form-control:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.2);
      outline: none;
    }
    
    /* Botões */
    .btn {
      display: inline-block;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
    }
    
    .btn-primary {
      background-color: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background-color: var(--secondary);
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background-color: var(--secondary);
      color: white;
    }
    
    .btn-danger {
      background-color: var(--danger);
      color: white;
    }
    
    .btn-success {
      background-color: var(--success);
      color: white;
    }
    
    .btn-block {
      display: block;
      width: 100%;
    }
    
    /* Estilos para horários */
    .horario-ocupado {
      color: #dc3545;
      text-decoration: line-through;
      background-color: #f8d7da;
    }
    
    .horario-disponivel {
      color: #28a745;
    }
    
    /* Layout responsivo */
    .row {
      display: flex;
      flex-wrap: wrap;
      margin: 0 -15px;
    }
    
    .col-md-6 {
      flex: 0 0 50%;
      max-width: 50%;
      padding: 0 15px;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
    }
    
    .tab.active {
      border-bottom-color: var(--primary);
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Tabela */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    th {
      background-color: #f8f9fa;
      font-weight: 600;
    }
    
    tr:hover {
      background-color: #f5f5f5;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .badge-success {
      background-color: #d4edda;
      color: #155724;
    }
    
    .badge-danger {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    .badge-warning {
      background-color: #fff3cd;
      color: #856404;
    }
    
    /* Link do salão */
    .salao-link {
      display: block;
      margin-top: 10px;
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 5px;
      word-break: break-all;
    }
    
    .copy-link {
      margin-left: 10px;
      padding: 3px 8px;
      font-size: 12px;
      background-color: var(--primary);
      color: white;
      border-radius: 3px;
      cursor: pointer;
    }
    
    .copy-link:hover {
      background-color: var(--secondary);
    }
    
    /* Switch para JSON Server */
    .api-switch {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    
    /* Estilos para serviços */
    .servico-item {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    
    .servico-item input {
      flex: 1;
    }
    
    @media (max-width: 768px) {
      .col-md-6 {
        flex: 0 0 100%;
        max-width: 100%;
      }
      
      .tabs {
        flex-direction: column;
      }
      
      .tab {
        border-bottom: none;
        border-left: 3px solid transparent;
      }
      
      .tab.active {
        border-bottom: none;
        border-left-color: var(--primary);
      }
      
      .servico-item {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- Todo o conteúdo HTML permanece igual -->
  <!-- ... -->

  <script>
    // Configurações
    const API_URL = 'http://localhost:3000';
    let useAPI = false;
    let db;
    
    // Variáveis globais
    let currentUser = null;
    let agendamentos = [];
    let saloes = [];
    
    // Inicializa o IndexedDB
    function initDB() {
      return new Promise((resolve) => {
        const request = indexedDB.open('SalaoAgendamentosDB', 1);
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('saloes')) {
            db.createObjectStore('saloes', { keyPath: 'id' });
          }
          if (!db.objectStoreNames.contains('agendamentos')) {
            db.createObjectStore('agendamentos', { keyPath: 'id' });
          }
        };
        
        request.onsuccess = (event) => {
          db = event.target.result;
          resolve(db);
        };
      });
    }
    
    // Funções para IndexedDB
    async function salvarDadosIndexedDB(tabela, dados) {
      return new Promise((resolve) => {
        const transaction = db.transaction(tabela, 'readwrite');
        const store = transaction.objectStore(tabela);
        
        const clearRequest = store.clear();
        
        clearRequest.onsuccess = () => {
          if (Array.isArray(dados)) {
            dados.forEach(item => {
              store.put(item);
            });
          } else {
            store.put(dados);
          }
          resolve();
        };
      });
    }
    
    async function carregarDadosIndexedDB(tabela) {
      return new Promise((resolve) => {
        const transaction = db.transaction(tabela, 'readonly');
        const store = transaction.objectStore(tabela);
        const request = store.getAll();
        
        request.onsuccess = () => {
          resolve(request.result || []);
        };
      });
    }
    
    // Funções para API (JSON Server)
    async function salvarDadosAPI(tabela, dados) {
      try {
        const response = await fetch(`${API_URL}/${tabela}`);
        const existingData = await response.json();
        
        for (const item of existingData) {
          await fetch(`${API_URL}/${tabela}/${item.id}`, {
            method: 'DELETE'
          });
        }
        
        if (Array.isArray(dados)) {
          for (const item of dados) {
            await fetch(`${API_URL}/${tabela}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(item)
            });
          }
        } else {
          await fetch(`${API_URL}/${tabela}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dados)
          });
        }
      } catch (error) {
        console.error('Erro ao salvar dados na API:', error);
        throw error;
      }
    }
    
    async function carregarDadosAPI(tabela) {
      try {
        const response = await fetch(`${API_URL}/${tabela}`);
        return await response.json();
      } catch (error) {
        console.error('Erro ao carregar dados da API:', error);
        return [];
      }
    }
    
    // Funções genéricas para salvar/carregar
    async function salvarDados(tabela, dados) {
      if (useAPI) {
        return await salvarDadosAPI(tabela, dados);
      } else {
        return await salvarDadosIndexedDB(tabela, dados);
      }
    }
    
    async function carregarDados(tabela) {
      if (useAPI) {
        return await carregarDadosAPI(tabela);
      } else {
        return await carregarDadosIndexedDB(tabela);
      }
    }
    
    // Função para alternar entre as abas
    function openTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.getElementById(tabId).classList.add('active');
      event.currentTarget.classList.add('active');
    }
    
    // Função para formatar a data
    function formatarData(data) {
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      return new Date(data).toLocaleDateString('pt-BR', options);
    }
    
    // Função para gerar horários disponíveis
    function gerarHorariosDisponiveis(abertura = '08:00', fechamento = '20:00', intervalo = 30, agendamentosDoDia = []) {
      const selectHora = document.getElementById('hora');
      selectHora.innerHTML = '<option value="">Selecione o horário</option>';
      
      const [aberturaHora, aberturaMinuto] = abertura.split(':').map(Number);
      const [fechamentoHora, fechamentoMinuto] = fechamento.split(':').map(Number);
      
      const inicioMinutos = aberturaHora * 60 + aberturaMinuto;
      const fimMinutos = fechamentoHora * 60 + fechamentoMinuto;
      
      for (let minutos = inicioMinutos; minutos < fimMinutos; minutos += intervalo) {
        const hora = Math.floor(minutos / 60);
        const minuto = minutos % 60;
        const horaFormatada = `${hora.toString().padStart(2, '0')}:${minuto.toString().padStart(2, '0')}`;
        
        const option = document.createElement('option');
        option.value = horaFormatada;
        option.textContent = horaFormatada;
        
        const horarioOcupado = agendamentosDoDia.some(ag => ag.hora === horaFormatada && ag.data === document.getElementById('data').value);
        
        if (horarioOcupado) {
          option.disabled = true;
          option.classList.add('horario-ocupado');
          option.textContent += ' (Ocupado)';
        } else {
          option.classList.add('horario-disponivel');
        }
        
        selectHora.appendChild(option);
      }
    }
    
    // Função para carregar horários disponíveis
    function carregarHorariosDisponiveis(data) {
      const dateObj = new Date(data);
      if (dateObj.getDay() === 0) {
        document.getElementById('hora').innerHTML = '<option value="" disabled>Fechado aos domingos</option>';
        return;
      }
      
      const salaoId = getSalaoIdFromUrl();
      const agendamentosDoDia = agendamentos.filter(ag => ag.data === data && ag.salaoId === salaoId);
      
      const salao = saloes.find(s => s.id === salaoId);
      
      const abertura = salao ? salao.abertura : '08:00';
      const fechamento = salao ? salao.fechamento : '20:00';
      
      gerarHorariosDisponiveis(abertura, fechamento, 30, agendamentosDoDia);
    }
    
    // Máscara para telefone
    document.getElementById('telefone').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
      value = value.replace(/(\d)(\d{4})$/, '$1-$2');
      e.target.value = value;
    });
    
    // Validação do formulário de agendamento
    document.getElementById('agendamento-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const nome = document.getElementById("nome").value.trim();
      const telefone = document.getElementById("telefone").value.trim();
      const servico = document.getElementById("servico").value;
      const data = document.getElementById("data").value;
      const hora = document.getElementById("hora").value;
      const salaoId = getSalaoIdFromUrl();
      
      if (!nome || !telefone || !servico || !data || !hora) {
        alert('Preencha todos os campos obrigatórios');
        return;
      }
      
      if (document.querySelector('#hora option:checked').disabled) {
        alert('Este horário já está ocupado. Por favor, selecione outro.');
        return;
      }
      
      const novoAgendamento = {
        id: Date.now().toString(),
        nome,
        telefone,
        servico,
        data,
        hora,
        status: 'confirmado',
        dataCriacao: new Date().toISOString(),
        salaoId: salaoId || 'default'
      };
      
      agendamentos.push(novoAgendamento);
      await salvarDados('agendamentos', agendamentos);
      
      alert(`Agendamento confirmado!\n\nNome: ${nome}\nTelefone: ${telefone}\nServiço: ${servico}\nData: ${formatarData(data)}\nHorário: ${hora}`);
      
      document.getElementById("agendamento-form").reset();
      document.getElementById('hora').innerHTML = '<option value="">Selecione primeiro a data</option>';
    });
    
    // Login do Salão
    document.getElementById('login-salao-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const email = document.getElementById('email-salao').value;
      const senha = document.getElementById('senha-salao').value;
      
      const salao = saloes.find(s => s.email === email && s.senha === senha);
      
      if (salao) {
        currentUser = { email, role: 'salao', salaoId: salao.id };
        document.getElementById('login-salao-form').style.display = 'none';
        document.getElementById('salao-dashboard').style.display = 'block';
        await carregarAgendamentosSalao(salao.id);
      } else {
        alert('E-mail ou senha incorretos');
      }
    });
    
    // Login Master
    document.getElementById('login-master-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const email = document.getElementById('email-master').value;
      const senha = document.getElementById('senha-master').value;
      
      if (email === 'admin@example.com' && senha === 'admin123') {
        currentUser = { email, role: 'master' };
        document.getElementById('login-master-form').style.display = 'none';
        document.getElementById('master-dashboard').style.display = 'block';
        await carregarSaloes();
      } else {
        alert('E-mail ou senha incorretos');
      }
    });
    
    // Função para adicionar novo campo de serviço
    function adicionarServico() {
      const container = document.getElementById('servicos-container');
      const novoServico = document.createElement('div');
      novoServico.className = 'servico-item';
      novoServico.innerHTML = `
        <input type="text" class="form-control servico-nome" placeholder="Nome do serviço">
        <input type="number" class="form-control servico-preco" placeholder="Preço" step="0.01">
        <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()">
          <i class="fas fa-trash"></i>
        </button>
      `;
      container.appendChild(novoServico);
    }
    
    // CADASTRO DE SALÃO CORRIGIDO (VERSÃO FUNCIONAL)
  document.getElementById('cadastro-salao-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  // Coleta dos dados do formulário
  const nome = document.getElementById('nome-salao').value;
  const endereco = document.getElementById('endereco-salao').value;
  const email = document.getElementById('email-salao-cadastro').value.trim().toLowerCase(); // Normaliza o e-mail
  const senha = document.getElementById('senha-salao-cadastro').value;
  const abertura = document.getElementById('abertura').value;
  const fechamento = document.getElementById('fechamento').value;

  // Validação básica do e-mail
  if (!email || !email.includes('@')) {
    alert('Por favor, insira um e-mail válido!');
    return;
  }

  // Verificação CORRIGIDA de e-mail existente (case insensitive)
  const emailExistente = saloes.some(s => s.email.toLowerCase() === email);
  
  if (emailExistente) {
    alert('Este e-mail já está cadastrado para outro salão.');
    return;
  }

  // Coleta de dias de funcionamento
  const diasCheckboxes = document.querySelectorAll('input[name="dias-funcionamento"]:checked');
  const diasFuncionamento = Array.from(diasCheckboxes).map(cb => cb.value);

  // Coleta de serviços
  const servicosItems = document.querySelectorAll('.servico-item');
  const servicos = Array.from(servicosItems).map(item => {
    const nomeServico = item.querySelector('.servico-nome').value.trim();
    const preco = parseFloat(item.querySelector('.servico-preco').value);
    return `${nomeServico} - R$${preco.toFixed(2)}`;
  }).filter(servico => servico && !servico.includes('undefined'));

  // Validação de serviços
  if (servicos.length === 0) {
    alert('Adicione pelo menos um serviço válido!');
    return;
  }

  // Cria o objeto do salão
  const novoSalao = {
    id: Date.now().toString(),
    nome,
    endereco,
    email,
    senha,
    horario: `${abertura} - ${fechamento}`,
    abertura,
    fechamento,
    diasFuncionamento,
    servicos,
    dataCriacao: new Date().toISOString()
  };

  try {
    // Adiciona ao array de salões e salva
    saloes.push(novoSalao);
    await salvarDados('saloes', saloes);
    
    // Feedback de sucesso
    const linkSalão = gerarLinkSalão(novoSalao.id);
    alert(`Salão "${nome}" cadastrado com sucesso!\n\nLink de acesso: ${linkSalão}`);
    
    // Limpa o formulário
    document.getElementById('cadastro-salao-form').reset();
    document.getElementById('servicos-container').innerHTML = `
      <div class="servico-item">
        <input type="text" class="form-control servico-nome" placeholder="Nome do serviço" value="Corte">
        <input type="number" class="form-control servico-preco" placeholder="Preço" value="20.00" step="0.01">
      </div>
    `;
    
    // Atualiza a lista de salões
    await carregarSaloes();
  } catch (error) {
    console.error('Erro ao cadastrar:', error);
    alert('Erro ao cadastrar. Tente novamente.');
  }
});
      
      saloes = saloes.filter(s => s.id !== id);
      await salvarDados('saloes', saloes);
      
      alert('Preencha os dados atualizados e clique em Cadastrar Salão para salvar as alterações.');
    }
    
    // Função para excluir salão
    async function excluirSalao(id) {
      if (confirm('Tem certeza que deseja excluir este salão? Todos os agendamentos serão perdidos.')) {
        saloes = saloes.filter(s => s.id !== id);
        await salvarDados('saloes', saloes);
        
        agendamentos = agendamentos.filter(ag => ag.salaoId !== id);
        await salvarDados('agendamentos', agendamentos);
        
        await carregarSaloes();
        alert('Salão excluído com sucesso!');
      }
    }
    
    // Filtro de data na área do salão
    document.getElementById('filtrar-data').addEventListener('change', async function() {
      if (currentUser && currentUser.role === 'salao') {
        await carregarAgendamentosSalao(currentUser.salaoId);
      }
    });
    
    // Switch para JSON Server
    document.getElementById('use-api').addEventListener('change', async function() {
      useAPI = this.checked;
      document.getElementById('api-status').textContent = useAPI 
        ? 'Modo online (JSON Server)' 
        : 'Modo offline (IndexedDB)';
      
      if (currentUser) {
        if (currentUser.role === 'master') {
          await carregarSaloes();
        } else if (currentUser.role === 'salao') {
          await carregarAgendamentosSalao(currentUser.salaoId);
        }
      }
    });
    
    // Verifica se o JSON Server está disponível
    async function verificarAPIDisponivel() {
      try {
        const response = await fetch(API_URL);
        return response.ok;
      } catch {
        return false;
      }
    }
    
    // Função para atualizar os serviços disponíveis com base no salão
    function atualizarServicos(salao) {
      const selectServico = document.getElementById('servico');
      selectServico.innerHTML = '<option value="">Escolha um serviço</option>';
      
      const servicosDisponiveis = salao?.servicos || [
        'Corte Simples - R$25',
        'Corte Degradê - R$30',
        'Corte e Barba - R$40',
        'Barba - R$20',
        'Sobrancelha - R$15'
      ];
      
      servicosDisponiveis.forEach(servico => {
        const option = document.createElement('option');
        option.value = servico;
        option.textContent = servico;
        selectServico.appendChild(option);
      });
    }
    
    // Inicialização
    window.addEventListener('load', async () => {
      await initDB();
      
      const apiDisponivel = await verificarAPIDisponivel();
      if (apiDisponivel) {
        document.getElementById('use-api').disabled = false;
        document.querySelector('.api-switch label').title = '';
      } else {
        document.getElementById('use-api').disabled = true;
        document.querySelector('.api-switch label').title = 'JSON Server não detectado. Execute "json-server --watch db.json" no terminal.';
      }
      
      saloes = await carregarDados('saloes');
      agendamentos = await carregarDados('agendamentos');
      
      const hoje = new Date();
      document.getElementById('data').min = hoje.toISOString().split('T')[0];
      
      const tresMesesAFrente = new Date();
      tresMesesAFrente.setMonth(tresMesesAFrente.getMonth() + 3);
      document.getElementById('data').max = tresMesesAFrente.toISOString().split('T')[0];
      
      document.getElementById('hora').innerHTML = '<option value="">Selecione primeiro a data</option>';
      
      document.getElementById('data').addEventListener('change', function() {
        const selectedDate = this.value;
        if (selectedDate) {
          carregarHorariosDisponiveis(selectedDate);
        }
      });
      
      const salaoId = getSalaoIdFromUrl();
      
      if (salaoId) {
        const salaoSelecionado = saloes.find(s => s.id === salaoId);
        if (salaoSelecionado) {
          document.getElementById('salao-nome').textContent = salaoSelecionado.nome;
          atualizarServicos(salaoSelecionado);
        }
      }
      
      if (saloes.length === 0) {
        saloes = [
          {
            id: '1',
            nome: 'Alicon Cortes - Matriz',
            endereco: 'Rua Principal, 123 - Centro',
            email: 'matriz@aliconcortes.com',
            senha: '123456',
            horario: '08:00 - 20:00',
            abertura: '08:00',
            fechamento: '20:00',
            diasFuncionamento: ['segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'],
            servicos: [
              'Corte Simples - R$25',
              'Corte Degradê - R$30',
              'Corte e Barba - R$40',
              'Barba - R$20',
              'Sobrancelha - R$15'
            ],
            dataCriacao: new Date().toISOString()
          },
          {
            id: '2',
            nome: 'Alicon Cortes - Filial',
            endereco: 'Avenida Secundária, 456 - Bairro',
            email: 'filial@aliconcortes.com',
            senha: '123456',
            horario: '09:00 - 19:00',
            abertura: '09:00',
            fechamento: '19:00',
            diasFuncionamento: ['segunda', 'terca', 'quarta', 'quinta', 'sexta'],
            servicos: [
              'Corte Simples - R$30',
              'Corte Degradê - R$35',
              'Barba - R$25'
            ],
            dataCriacao: new Date().toISOString()
          }
        ];
        await salvarDados('saloes', saloes);
      }
      
      if (agendamentos.length === 0) {
        agendamentos = [
          {
            id: '1',
            nome: 'João Silva',
            telefone: '(11) 98765-4321',
            servico: 'Corte e Barba - R$40',
            data: new Date().toISOString().split('T')[0],
            hora: '10:00',
            status: 'confirmado',
            dataCriacao: new Date().toISOString(),
            salaoId: '1'
          },
          {
            id: '2',
            nome: 'Maria Souza',
            telefone: '(11) 91234-5678',
            servico: 'Corte Degradê - R$30',
            data: new Date(Date.now() + 86400000).toISOString().split('T')[0],
            hora: '14:30',
            status: 'confirmado',
            dataCriacao: new Date().toISOString(),
            salaoId: '1'
          }
        ];
        await salvarDados('agendamentos', agendamentos);
      }
    });
  </script>
</body>
</html>
